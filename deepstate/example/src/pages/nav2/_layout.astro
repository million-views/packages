---
import BaseLayout from "@layouts/Layout.astro";
import { NavigatorWithRouter } from "./_navigator.tsx";

const pathname = Astro.url.pathname;
const searchParams = Astro.url.searchParams;
const viewParam = searchParams.get('view');
const subviewParam = searchParams.get('subview');

// Ensure we have a clean path without trailing slashes for consistent matching
const cleanPath = pathname.endsWith('/') && pathname !== '/' 
  ? pathname.slice(0, -1) 
  : pathname;
---

<BaseLayout>
  <div class="min-h-screen flex flex-col">
    <!-- Server-side render the navigator but hydrate it on the client -->
    <NavigatorWithRouter client:load />
    
    <!-- Hidden metadata to ensure state persists across page loads -->
    <script id="nav-state" type="application/json" set:html={JSON.stringify({
      pathname: cleanPath,
      view: viewParam,
      subview: subviewParam
    })}>
    </script>
    
    <!-- Initialize navigation state from URL -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        try {
          // Get state from embedded JSON
          const stateElement = document.getElementById('nav-state');
          if (stateElement) {
            const state = JSON.parse(stateElement.textContent || '{}');
            
            // Delay slightly to ensure components are mounted
            setTimeout(() => {
              // Dispatch event to initialize navigation state
              window.dispatchEvent(new CustomEvent('initNavigationState', { 
                detail: state 
              }));
            }, 100);
          }
        } catch (error) {
          console.error('Error initializing navigation state:', error);
        }
      });

      // Debug navigation events
      window.addEventListener('viewChange', (e) => {
        console.log('View change event:', e.detail);
      });
      
      window.addEventListener('subViewChange', (e) => {
        console.log('SubView change event:', e.detail);
      });
      
      window.addEventListener('navigationStateChange', (e) => {
        console.log('Navigation state change:', e.detail);
      });
    </script>
    
    <!-- Page content from <slot /> -->
    <slot />
  </div>
</BaseLayout>